<!-- chat.html: Student-Instructor Chat UI -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with Instructor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .chat-container { max-width: 600px; margin: 40px auto; border: 1px solid #ccc; border-radius: 8px; background: #fff; }
        .chat-messages { height: 400px; overflow-y: auto; padding: 16px; background: #f9f9f9; }
        .chat-input { display: flex; gap: 8px; padding: 16px; border-top: 1px solid #eee; }
        .message-sent { text-align: right; color: #0d6efd; }
        .message-received { text-align: left; color: #212529; }
        .message-meta { font-size: 0.8em; color: #888; }
    </style>
</head>
<body>
<div class="chat-container shadow">
    <div class="p-3 bg-primary text-white rounded-top">
        <h4 class="mb-0">Chat with <span id="chat-with"></span></h4>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
        <button id="send-btn" class="btn btn-primary">Send</button>
    </div>
</div>
<script>
// Get the other user's username from the query string
function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}
const otherUser = getQueryParam('user');
document.getElementById('chat-with').textContent = otherUser || 'Instructor';

// Fetch chat history
function fetchChatHistory() {
    fetch(`/api/chat/history?other_user=${encodeURIComponent(otherUser)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const chatBox = document.getElementById('chat-messages');
                chatBox.innerHTML = '';
                const currentUser = localStorage.getItem('username');
                data.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = msg.sender === currentUser ? 'message-sent mb-2' : 'message-received mb-2';
                    div.innerHTML = `<div>${msg.message}</div><div class='message-meta'>${msg.sender} | ${new Date(msg.timestamp).toLocaleTimeString()}</div>`;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
}

// Send a message
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message) return;
    fetch('/api/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receiver: otherUser, message })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            fetchChatHistory();
        } else {
            alert('Failed to send message');
        }
    });
}

document.getElementById('send-btn').onclick = sendMessage;
document.getElementById('message-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') sendMessage();
});

// Poll for new messages every 2 seconds
setInterval(fetchChatHistory, 2000);
fetchChatHistory();
</script>
</body>
</html> 