<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Results - Study Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .filters {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .filters input, .filters select {
            margin: 0 10px;
            padding: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
        }
        .edit-btn, .delete-btn {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .edit-btn {
            background-color: #4CAF50;
            color: white;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 50%;
            border-radius: 5px;
        }
        .modal input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
        }
        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 8px 15px;
            margin-left: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .save-btn {
            background-color: #4CAF50;
            color: white;
        }
        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        .message {
            display: none;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Manage Results</h1>
        <a href="/instructor/dashboard" class="back-btn">Back to Dashboard</a>

        <div id="errorMessage" class="message error"></div>
        <div id="successMessage" class="message success"></div>

        <div class="filters">
            <input type="text" id="studentFilter" placeholder="Student Name">
            <input type="text" id="subjectFilter" placeholder="Subject">
            <select id="yearFilter">
                <option value="">All Years</option>
                <option value="1">Year 1</option>
                <option value="2">Year 2</option>
                <option value="3">Year 3</option>
                <option value="4">Year 4</option>
            </select>
            <select id="semesterFilter">
                <option value="">All Semesters</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
            </select>
            <button onclick="applyFilters()" id="applyFilters">Apply Filters</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Subject</th>
                    <th>Marks</th>
                    <th>Grade</th>
                    <th>Credits</th>
                    <th>Year</th>
                    <th>Semester</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <h2>Edit Result</h2>
                <input type="hidden" id="editResultId">
                <p>Student: <span id="editStudentName"></span></p>
                <p>Subject: <span id="editSubject"></span></p>
                <input type="number" id="editMarks" placeholder="Marks" min="0" max="100">
                <input type="text" id="editGrade" placeholder="Grade">
                <input type="number" id="editCredits" placeholder="Credits" min="0">
                <div class="modal-buttons">
                    <button onclick="closeEditModal()" class="cancel-btn" id="closeModal">Cancel</button>
                    <button onclick="updateResult()" class="save-btn" id="saveChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        function checkAuth() {
            const token = localStorage.getItem('instructorToken');
            if (!token) {
                window.location.href = '/';
                return;
            }
        }

        // Load all results
        async function loadResults() {
            try {
                const token = localStorage.getItem('instructorToken');
                const response = await fetch('/api/results', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data.results);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('An error occurred while loading results');
            }
        }

        // Display results in the table
        function displayResults(results) {
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.student_name}</td>
                    <td>${result.subject}</td>
                    <td>${result.marks}</td>
                    <td>${result.grade}</td>
                    <td>${result.credits}</td>
                    <td>${result.academic_year}</td>
                    <td>${result.semester}</td>
                    <td>
                        <button onclick="openEditModal(${result.id}, '${result.student_name}', '${result.subject}', ${result.marks}, '${result.grade}', ${result.credits})" class="edit-btn">Edit</button>
                        <button onclick="deleteResult(${result.id})" class="delete-btn">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Apply filters
        async function applyFilters() {
            const student = document.getElementById('studentFilter').value;
            const subject = document.getElementById('subjectFilter').value;
            const year = document.getElementById('yearFilter').value;
            const semester = document.getElementById('semesterFilter').value;

            try {
                const token = localStorage.getItem('instructorToken');
                const response = await fetch(`/api/results/filter?student=${student}&subject=${subject}&year=${year}&semester=${semester}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data.results);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('An error occurred while filtering results');
            }
        }

        // Open edit modal
        function openEditModal(id, studentName, subject, marks, grade, credits) {
            document.getElementById('editResultId').value = id;
            document.getElementById('editStudentName').textContent = studentName;
            document.getElementById('editSubject').textContent = subject;
            document.getElementById('editMarks').value = marks;
            document.getElementById('editGrade').value = grade;
            document.getElementById('editCredits').value = credits;
            document.getElementById('editModal').style.display = 'block';
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Update result
        async function updateResult() {
            const id = document.getElementById('editResultId').value;
            const marks = document.getElementById('editMarks').value;
            const grade = document.getElementById('editGrade').value;
            const credits = document.getElementById('editCredits').value;

            if (!marks || !grade || !credits) {
                showError('Please fill in all fields');
                return;
            }

            try {
                const token = localStorage.getItem('instructorToken');
                const response = await fetch(`/api/results/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ marks, grade, credits })
                });
                const data = await response.json();
                
                if (data.success) {
                    closeEditModal();
                    loadResults();
                    showSuccess('Result updated successfully');
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('An error occurred while updating the result');
            }
        }

        // Delete result
        async function deleteResult(id) {
            if (!confirm('Are you sure you want to delete this result?')) {
                return;
            }

            try {
                const token = localStorage.getItem('instructorToken');
                const response = await fetch(`/api/results/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    loadResults();
                    showSuccess('Result deleted successfully');
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('An error occurred while deleting the result');
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadResults();
        });
    </script>
</body>
</html> 